buildscript {
  ext {
    dockerComposePluginVersion = "0.17.6"
    springBoot = "3.2.2"
    dependencyManagement = "1.1.4"
    flyway = "9.22.3"
    spotbugs = "5.2.5"
    guava = "33.0.0-jre"
    commonsLang3 = "3.14.0"
    groovy = "4.0.17"
    spock = "2.4-M1-groovy-4.0"
  }
  repositories {
    mavenCentral()
  }
  dependencies {
    classpath "com.avast.gradle:gradle-docker-compose-plugin:${dockerComposePluginVersion}"
  }
}

plugins {
  id "org.springframework.boot" version "${springBoot}"
  id "io.spring.dependency-management" version "${dependencyManagement}"
  id "org.flywaydb.flyway" version "${flyway}"
  id "com.github.spotbugs" version "${spotbugs}"
  id "java"
  id "checkstyle"
  id "groovy"
}

group = "com.uyawer"
version = "1.0.0"

java {
  toolchain {
    languageVersion = JavaLanguageVersion.of(JavaVersion.VERSION_17.majorVersion)
  }
}

configurations {
  compileOnly {
    extendsFrom annotationProcessor
  }
}

repositories {
  mavenCentral()
  maven {
    url "https://repo.spring.io/milestone"
  }
}

dependencies {
  implementation "org.springframework.boot:spring-boot-starter-web:${springBoot}"
  implementation "org.springframework.boot:spring-boot-starter-data-jpa:${springBoot}"
  implementation "org.springframework.boot:spring-boot-starter-security:${springBoot}"
  implementation "org.springframework.boot:spring-boot-starter-thymeleaf:${springBoot}"
  implementation "org.springframework.boot:spring-boot-starter-validation:${springBoot}"
  implementation "org.springframework.boot:spring-boot-starter-actuator:${springBoot}"
  testImplementation "org.springframework.boot:spring-boot-starter-test:${springBoot}"
  developmentOnly "org.springframework.boot:spring-boot-devtools:${springBoot}"

  implementation "org.thymeleaf.extras:thymeleaf-extras-springsecurity6"

  runtimeOnly "org.postgresql:postgresql"

  compileOnly "org.projectlombok:lombok"
  annotationProcessor "org.projectlombok:lombok"

  implementation "org.flywaydb:flyway-core:${flyway}"
  implementation "com.google.guava:guava:${guava}"
  implementation "org.apache.commons:commons-lang3:${commonsLang3}"
  testImplementation "org.apache.groovy:groovy-all:${groovy}"

  testImplementation "org.spockframework:spock-core:${spock}"
  testImplementation "org.spockframework:spock-spring:${spock}"
}

tasks.named("test") {
  useJUnitPlatform()
  checkstyleMain
  spotbugsMain
}

flyway {
  driver = "org.postgresql.Driver"
  url = "jdbc:postgresql://localhost:15432/portal"
  user = "portaluser"
  password = "portaluser0428"
}

apply plugin: "docker-compose"
dockerCompose {
  useComposeFiles = ["docker/docker-compose.yml"]
}

checkstyle {
  toolVersion "10.3"
  configFile file("./config/google_checks.xml")
}

spotbugsMain {
  reports {
    html {
      required = true
      outputLocation = file("$buildDir/reports/spotbugs/main/spotbugs.html")
      stylesheet = "fancy-hist.xsl"
    }
  }
}

spotbugs {
  reportLevel = "high"
}
